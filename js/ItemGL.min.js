/**
* The ItemGL plugin implements an application that
* simply lets the user customize an item using WebGL and ThreeJs.
*
* @author  Llogari Casas
* @version 1.0
* @since   2015-02-21 
*/

(function(c){var b=c.extend({id:"canvas",width:window.innerWidth-350,height:window.innerHeight-100,clearColor:15658734,core:{object:[],renderer:null,camera:null,scene:null,light:null,controls:null,canvas:null,spotLight:null,group:null,interval:null,mouse:null},numObj:7,objGeometry:[{x:15,y:1,z:15},{x:2,y:16,z:2},{x:2,y:16,z:2},{x:2,y:32,z:2},{x:2,y:32,z:2},{x:12,y:3,z:1},{x:12,y:3,z:1}],objPosition:[{x:8,y:6,z:3},{x:1,y:-2,z:10},{x:15,y:-2,z:10},{x:1,y:6,z:-5},{x:15,y:6,z:-5},{x:8,y:20,z:-5},{x:8,y:15,z:-5}],buttonLeft:["pointer-div","move-div","rotate-div","view-div","delete-div","camera-div","light-div","cube-div","sphere-div","scale-div","plane-div"],currentAction:null,currentObject:null,textFile:null},b);var a={init:function(e){if(typeof e==="object"){c.extend(e,this.options)}b.core.scene=new THREE.Scene();b.core.mouse=new THREE.Vector2();b.core.camera=new THREE.PerspectiveCamera(50,b.width/b.height,0.1,1000);b.core.renderer=new THREE.WebGLRenderer();b.core.renderer.setClearColor(new THREE.Color(15658734,1));b.core.renderer.setSize(b.width,b.height);b.core.renderer.shadowMapEnabled=true;var d=new THREE.Mesh(new THREE.PlaneGeometry(500,500,50,50),new THREE.MeshBasicMaterial({color:0,wireframe:true}));d.rotation.x=Math.PI/2;d.isSelectable=false;b.core.scene.add(d);b.core.camera.position.x=10;b.core.camera.position.y=30;b.core.camera.position.z=60;b.core.camera.lookAt(new THREE.Vector3(10,0,0));b.core.light=new THREE.AmbientLight(789516);b.core.scene.add(b.core.light);b.core.spotLight=new THREE.SpotLight(16777215);b.core.spotLight.position.set(-30,60,60);b.core.spotLight.castShadow=true;b.core.scene.add(b.core.spotLight);b.core.controls=new THREE.TrackballControls(b.core.camera);b.core.controls.rotateSpeed=3;b.core.controls.zoomSpeed=1;b.core.controls.panSpeed=1;b.core.controls.staticMoving=true;c("#"+b.id).append(b.core.renderer.domElement);document.getElementById("pointer-div").style.backgroundColor="#E1B20E";b.currentAction="pointer";a.render();a.initListeners();b.core.renderer.render(b.core.scene,b.core.camera);document.addEventListener("mousedown",a.onDocumentMouseDown);document.addEventListener("keydown",a.onDocumentKeyDown)},onDocumentMouseDown:function(p){var n=new THREE.Raycaster();var d={x:0,y:0};p.preventDefault();if(p.clientX<51){d.x=null}else{if(p.clientX>50&&p.clientX<window.innerWidth-300){d.x=p.clientX-50}else{d.x=null}}if(p.clientY<51){d.y=null}else{if(p.clientY>50&&p.clientY<window.innerHeight-50){d.y=p.clientY-50}else{d.y=null}}if(d.x!=null&&d.y!=null){b.core.mouse.x=(d.x/b.core.renderer.domElement.clientWidth)*2-1;b.core.mouse.y=-(d.y/b.core.renderer.domElement.clientHeight)*2+1;n.setFromCamera(b.core.mouse,b.core.camera);var f=n.intersectObjects(b.core.scene.children,true);if(f.length>0){switch(b.currentAction){case"delete":if(f[0].object.isSelectable){f[0].object.isSelectable=false;f[0].object.material.transparent=true;f[0].object.material.opacity=0;f[0].object.material.needsUpdate=true;b.core.scene.remove(f[0].object)}break;case"hide":if(f[0].object.isSelectable){if(!f[0].object.isHidden){f[0].object.material.transparent=true;f[0].object.material.opacity=0.3;f[0].object.material.needsUpdate=true;f[0].object.isHidden=true}else{f[0].object.material.transparent=true;f[0].object.material.opacity=1;f[0].object.material.needsUpdate=true;f[0].object.isHidden=false}}break}if(f[0].object.isSelectable){b.currentObject=f[0].object;document.getElementById("item-id").innerHTML=f[0].object.id;document.getElementById("item-material").innerHTML=f[0].object.material.type;document.getElementById("item-color").innerHTML="R: "+f[0].object.material.color.r+"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;G: "+f[0].object.material.color.g+"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;B: "+f[0].object.material.color.b+"";document.getElementById("item-position").innerHTML="X: "+parseInt(f[0].point.x)+"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Y: "+parseInt(f[0].point.y)+"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Z: "+parseInt(f[0].point.z);document.getElementById("item-geometry").innerHTML=f[0].object.geometry.type}}else{var g=new THREE.Vector3();g.set(b.core.mouse.x,b.core.mouse.y,0.5);g.unproject(b.core.camera);var o=g.sub(b.core.camera.position).normalize();var j=-b.core.camera.position.z/o.z;var k=b.core.camera.position.clone().add(o.multiplyScalar(j));switch(b.currentAction){case"light":var i=new THREE.SpotLight(16777215);i.position.set(k.x,k.y,k.z);i.castShadow=true;i.isHidden=false;i.isSelectable=true;b.core.scene.add(i);var t=THREE.ImageUtils.loadTexture("sprite/Light.png");var l=new THREE.SpriteMaterial({map:t,color:16777215,fog:false});var m=new THREE.Sprite(l);m.position.set(k.x,k.y,k.z);m.isHidden=false;m.isSelectable=true;b.core.scene.add(m);break;case"camera":var q=new THREE.PerspectiveCamera(50,b.width/b.height,0.1,1000);q.position.set(k.x,k.y,k.z);q.isHidden=false;q.isSelectable=true;b.core.scene.add(q);var t=THREE.ImageUtils.loadTexture("sprite/Camera.png");var l=new THREE.SpriteMaterial({map:t,color:16777215,fog:false});var m=new THREE.Sprite(l);m.position.set(k.x,k.y,k.z);m.isHidden=false;m.isSelectable=true;b.core.scene.add(m);break;case"cube":var s=new THREE.BoxGeometry(15,15,15);var r=new THREE.MeshPhongMaterial();r.needsUpdate=true;r.side=THREE.DoubleSide;var e=new THREE.Mesh(s,r);e.position.x=k.x;e.position.y=k.y;e.position.z=k.z;e.isHidden=false;e.isSelectable=true;b.core.scene.add(e);break;case"sphere":var s=new THREE.SphereGeometry(5,32,32);var r=new THREE.MeshPhongMaterial();r.needsUpdate=true;r.side=THREE.DoubleSide;var e=new THREE.Mesh(s,r);e.position.x=k.x;e.position.y=k.y;e.position.z=k.z;e.isHidden=false;e.isSelectable=true;b.core.scene.add(e);break;case"plane":var u=new THREE.PlaneGeometry(50,50);var r=new THREE.MeshPhongMaterial();r.needsUpdate=true;r.side=THREE.DoubleSide;var h=new THREE.Mesh(u,r);h.rotation.x=Math.PI/2;h.position.x=k.x;h.position.y=k.y;h.position.z=k.z;h.isSelectable=true;h.isHidden=false;b.core.scene.add(h);break;case"translate":b.currentObject.position.set(k.x,k.y,k.z);break}document.getElementById("item-id").innerHTML="--";document.getElementById("item-material").innerHTML="--";document.getElementById("item-color").innerHTML="--";document.getElementById("item-position").innerHTML="--";document.getElementById("item-geometry").innerHTML="--"}}},onDocumentKeyDown:function(d){if(b.currentAction=="rotate"){switch(d.keyCode){case 37:b.currentObject.rotation.y+=20;break;case 38:b.currentObject.rotation.x+=20;break;case 39:b.currentObject.rotation.y-=20;break;case 40:b.currentObject.rotation.x-=20;break}}if(b.currentAction=="scale"){switch(d.keyCode){case 49:b.currentObject.scale.x+=0.1;b.currentObject.scale.y+=0.1;b.currentObject.scale.z+=0.1;break;case 50:b.currentObject.scale.x-=0.1;b.currentObject.scale.y-=0.1;b.currentObject.scale.z-=0.1;break}}},computeOffset:function(){var h={x:0,y:0,z:0};var g={x:0,y:0,z:0};var e={x:0,y:0,z:0};for(var f=0;f<b.objPosition.length;f++){var d=b.objPosition[f];if(d.x>h.x){h.x=d.x}else{if(d.x<g.x){g.x=d.x}}if(d.y>h.y){h.y=d.y}else{if(d.y<g.y){g.y=d.y}}if(d.z>h.z){h.z=d.z}else{if(d.z<g.z){g.z=d.z}}}e.x=g.x+(h.x-g.x)/2;e.y=g.y+(h.y-g.y)/2;e.z=g.z+(h.z-g.z)/2;return e},render:function(){requestAnimationFrame(a.render);b.core.controls.update();b.core.renderer.render(b.core.scene,b.core.camera)},addMaterial:function(e,g){var f=THREE.ImageUtils.loadTexture(g);var d=new THREE.MeshPhongMaterial();d.map=f;d.side=THREE.DoubleSide;d.needsUpdate=true;var h=new THREE.Mesh(e,d);return h},clearBackground:function(){for(var d=0;d<b.buttonLeft.length;d++){document.getElementById(b.buttonLeft[d]).style.backgroundColor="#222"}document.getElementsByTagName("body")[0].style.cursor="auto"},translateObject:function(){a.clearBackground();document.getElementById("move-div").style.backgroundColor="#E1B20E";document.getElementsByTagName("body")[0].style.cursor="url('cursor/Move.png'), auto";b.currentAction="translate"},rotateObject:function(){a.clearBackground();document.getElementById("rotate-div").style.backgroundColor="#E1B20E";document.getElementsByTagName("body")[0].style.cursor="url('cursor/Rotate.png'), auto";b.currentAction="rotate"},scaleObject:function(){a.clearBackground();document.getElementById("scale-div").style.backgroundColor="#E1B20E";document.getElementsByTagName("body")[0].style.cursor="url('cursor/Scale.png'), auto";b.currentAction="scale"},hideObject:function(){a.clearBackground();document.getElementById("view-div").style.backgroundColor="#E1B20E";b.currentAction="hide"},deleteObject:function(){a.clearBackground();document.getElementById("delete-div").style.backgroundColor="#E1B20E";b.currentAction="delete"},addCamera:function(){a.clearBackground();document.getElementById("camera-div").style.backgroundColor="#E1B20E";b.currentAction="camera"},addLight:function(){a.clearBackground();document.getElementById("light-div").style.backgroundColor="#E1B20E";b.currentAction="light"},addCube:function(){a.clearBackground();document.getElementById("cube-div").style.backgroundColor="#E1B20E";b.currentAction="cube"},addSphere:function(){a.clearBackground();document.getElementById("sphere-div").style.backgroundColor="#E1B20E";b.currentAction="sphere"},addPlane:function(){a.clearBackground();document.getElementById("plane-div").style.backgroundColor="#E1B20E";b.currentAction="plane"},moveView:function(){a.clearBackground();document.getElementById("pointer-div").style.backgroundColor="#E1B20E";b.currentAction="pointer"},changeMaterialColor:function(f){if(b.currentObject!=null){var d=new THREE.Color(f.target.style.backgroundColor);var e=new THREE.MeshPhongMaterial();e.map=null;e.side=THREE.DoubleSide;e.color=d;e.needsUpdate=true;b.currentObject.material=e}},changeMaterialTexture:function(g){if(b.currentObject!=null){var d=g.target.style.backgroundImage;var h=d.substring(4,d.length-1);var f=THREE.ImageUtils.loadTexture(h);var e=new THREE.MeshPhongMaterial();e.map=f;e.side=THREE.DoubleSide;b.currentObject.material=e}},resetScene:function(){window.location.href="."},exportScene:function(){var d=b.core.scene.toJSON();localStorage.setItem("json",JSON.stringify(d));c.ajax({type:"POST",url:"http://digitalmediafinalproject.kaleidoscop.net/demo/upload/export.php",data:{jsonfile:d},success:function(e){window.open(e,"Exported Scene")}})},makeTextFile:function(e){var d=new Blob([e],{type:"text/plain"});if(b.textFile!==null){window.URL.revokeObjectURL(b.textFile)}b.textFile=window.URL.createObjectURL(d);return b.textFile},executeScript:function(){var g=document.getElementById("scriptText");var f=g.value;var d=document.getElementById("scriptContainer");var e;if(d){d.parentNode.removeChild(d)}e=document.createElement("script");e.id="scriptContainer";e.text=g.value;document.body.appendChild(e);c("#scriptModal").modal("hide")},initListeners:function(){document.getElementById("move-div").addEventListener("click",a.translateObject);document.getElementById("pointer-div").addEventListener("click",a.moveView);document.getElementById("scale-div").addEventListener("click",a.scaleObject);document.getElementById("rotate-div").addEventListener("click",a.rotateObject);document.getElementById("view-div").addEventListener("click",a.hideObject);document.getElementById("delete-div").addEventListener("click",a.deleteObject);document.getElementById("camera-div").addEventListener("click",a.addCamera);document.getElementById("light-div").addEventListener("click",a.addLight);document.getElementById("light-div").addEventListener("click",a.addLight);document.getElementById("cube-div").addEventListener("click",a.addCube);document.getElementById("sphere-div").addEventListener("click",a.addSphere);document.getElementById("plane-div").addEventListener("click",a.addPlane);document.getElementById("resetScene").addEventListener("click",a.resetScene);document.getElementById("executeScript").addEventListener("click",a.executeScript);document.getElementById("exportFile").addEventListener("click",a.exportScene);var f=document.getElementsByClassName("color-div");for(var e=0;e<f.length;e++){f[e].addEventListener("click",a.changeMaterialColor)}var d=document.getElementsByClassName("image-div");for(var e=0;e<d.length;e++){d[e].addEventListener("click",a.changeMaterialTexture)}c("#scriptModal").on("show.bs.modal",function(g){window.setTimeout(function(){document.getElementById("scriptText").focus()},1000)});c("#saveModal").on("show.bs.modal",function(g){window.setTimeout(function(){document.getElementById("sceneName").focus()},1000)});c("#contactModal").on("show.bs.modal",function(g){window.setTimeout(function(){document.getElementById("name").focus()},1000)});c("#importFile").unbind("click").bind("click",function(){c("#uploadFile").click()});c("#uploadFile").fileupload({url:"http://digitalmediafinalproject.kaleidoscop.net/demo/upload/index.php",dataType:"json",done:function(i,h){if(parseInt(h.result.response)==1){switch(h.result.type.toUpperCase()){case"DAE":var g=new THREE.ColladaLoader();g.options.convertUpAxis=true;g.load(h.result.url,function(k){var j=k.scene;j.traverse(function(o){o.isSelectable=true;o.isHidden=false;var l=new THREE.Color("#FFFFFF");var m=new THREE.MeshPhongMaterial();m.map=null;m.side=THREE.DoubleSide;m.color=l;m.needsUpdate=true;o.material=m;if(o instanceof THREE.SkinnedMesh){var n=new THREE.Animation(o,o.geometry.animation);n.play()}});j.scale.x=j.scale.y=j.scale.z=0.02;j.updateMatrix();b.core.object[b.numObj]=j;b.core.scene.add(b.core.object[b.numObj]);b.numObj++});break;case"JSON":case"JS":var g=new THREE.JSONLoader();g.load(h.result.url,function(o,j){var n=new THREE.MeshFaceMaterial(j);var l=new THREE.Mesh(o,n);l.scale.x=l.scale.y=l.scale.z=0.02;l.isSelectable=true;l.isHidden=false;var k=new THREE.Color("#FFFFFF");var m=new THREE.MeshPhongMaterial();m.map=null;m.color=k;m.needsUpdate=true;m.side=THREE.DoubleSide;l.material=m;b.core.scene.add(l)});break;case"OBJ":var g=new THREE.OBJLoader();g.load(h.result.url,function(j){j.traverse(function(m){m.isSelectable=true;m.isHidden=false;var k=new THREE.Color("#FFFFFF");var l=new THREE.MeshPhongMaterial();l.map=null;l.side=THREE.DoubleSide;l.color=k;l.needsUpdate=true;m.material=l});j.scale.x=j.scale.y=j.scale.z=0.1;b.core.scene.add(j)});break}}else{alert("File type not compatible")}}})}};c.fn.ItemGL=function(d){if(typeof d==="undefined"){d="init"}if(a[d]){return a[d].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof d==="object"||!d){return a.init.apply(this,arguments)}else{c.error("Method "+d+" does not exist on jQuery")}}}})(jQuery);
